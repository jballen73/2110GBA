#include "graphics.h"
#include "gba.h"
#include "images/playerChar.h"
#include "logic.h"
#include <stdio.h>
// TA-TODO: Include any header files for images generated by nin10kit.
// Example for the provided garbage image:
//#include "images/garbage.h"

volatile OamEntry shadow[128];
volatile OamEntry* playerCharacter = shadow;
void graphicsInit(void) {
    DMA[3].src = playerChar_palette;
    DMA[3].dst = SPRITEPAL;
    DMA[3].cnt = PLAYERCHAR_PALETTE_LENGTH | DMA_ON;

    DMA[3].src = playerChar;
    DMA[3].dst = &CHARBLOCKBASE[5];
    DMA[3].cnt = PLAYERCHAR_LENGTH | DMA_ON;

    for(int i = 0; i < 128; i++) {
        shadow[i].attr0 = ATTR0_HIDE;
    }
    playerCharacter = shadow;
    playerCharacter->attr0 = 50 | PLAYERCHAR_PALETTE_TYPE | PLAYERCHARACTERSPRITE_SPRITE_SHAPE;
    playerCharacter->attr1 = 50 | PLAYERCHARACTERSPRITE_SPRITE_SIZE;
    playerCharacter->attr2 = PLAYERCHARACTERSPRITE_PALETTE_ID | PLAYERCHARACTERSPRITE_ID;
}
// TA-TODO: Add any draw/undraw functions for sub-elements of your app here.
// For example, for a snake game, you could have a drawSnake function
// or a drawFood function
//
// e.g.:
// static void drawSnake(Snake* snake);
// static void drawFood(Food* food);
static void drawPlayer(int xpos, int ypos) {
    //playerCharacter->attr0 = (playerCharacter->attr0 & ~0x00FF) | (ypos & 0x00FF);
    playerCharacter->attr0 = ypos | PLAYERCHAR_PALETTE_TYPE | PLAYERCHARACTERSPRITE_SPRITE_SHAPE;
    playerCharacter->attr1 = (xpos&0x01FF) | PLAYERCHARACTERSPRITE_SPRITE_SIZE;
    //playerCharacter->attr1 = (playerCharacter->attr1 & ~0x00FF) | (xpos & 0x00FF);
    DMA[3].src = playerCharacter;
    DMA[3].dst = OAMMEM;
    DMA[3].cnt = 128*2 | DMA_ON;
}
// This function will be used to draw everything about the app
// including the background and whatnot.
void fullDrawAppState(AppState *state) {
    // TA-TODO: IMPLEMENT.
    drawFullScreenImageDMA(state->backgroundImage);
    drawPlayer(state->thePlayerCharacter->xpos, state->thePlayerCharacter->ypos);
}

// This function will be used to undraw (i.e. erase) things that might
// move in a frame. E.g. in a Snake game, erase the Snake, the food & the score.
void undrawAppState(AppState *state) {
    // TA-TODO: IMPLEMENT.
    UNUSED(state);
}

// This function will be used to draw things that might have moved in a frame.
// For example, in a Snake game, draw the snake, the food, the score.
void drawAppState(AppState *state) {
    // TA-TODO: IMPLEMENT.
    drawPlayer(state->thePlayerCharacter->xpos, state->thePlayerCharacter->ypos);
}


